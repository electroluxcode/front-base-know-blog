import{_ as s,o as a,c as n,R as l}from"./chunks/framework.408c4d71.js";const A=JSON.parse('{"title":"9.webassembly","description":"","frontmatter":{},"headers":[],"relativePath":"know/优化/9wasm.md","filePath":"know/优化/9wasm.md","lastUpdated":null}'),p={name:"know/优化/9wasm.md"},o=l(`<h1 id="_9-webassembly" tabindex="-1">9.webassembly <a class="header-anchor" href="#_9-webassembly" aria-label="Permalink to &quot;9.webassembly&quot;">​</a></h1><p>[toc]</p><nav class="table-of-contents"><ul><li><a href="#_9-1-基础">9.1.基础</a><ul><li><a href="#_9-1-1chrome如何运行wasm">9.1.1chrome如何运行Wasm</a></li><li><a href="#_9-1-2chrome-编译流程">9.1.2chrome 编译流程</a></li><li><a href="#_9-1-3流式调用-和-编译">9.1.3流式调用 和 编译</a></li></ul></li><li><a href="#_9-2-emscript-c">9.2.emscript | c</a><ul><li><a href="#_9-2-1-环境">9.2.1 环境</a></li><li><a href="#_9-2-2-c语言示例">9.2.2 c语言示例</a></li><li><a href="#_9-2-3-加载工具">9.2.3 加载工具</a></li><li><a href="#_9-2-4-js加载调用">9.2.4 js加载调用</a></li></ul></li><li><a href="#_9-3-emscript-c-打包成外部dll">9.3 emscript | c | 打包成外部dll</a><ul><li><a href="#_9-3-1-cpp文件">9.3.1 cpp文件</a></li><li><a href="#_9-3-2-h-文件">9.3.2 .h 文件</a></li></ul></li><li><a href="#_9-4-node-addon-api-c">9.4 Node-addon-api | c++</a><ul><li><a href="#_9-4-1-gyp-xx-cc">9.4.1 gyp | xx.cc</a></li><li><a href="#_9-4-2-运行">9.4.2 运行</a></li><li><a href="#_9-4-3-调用">9.4.3 调用</a></li></ul></li></ul></nav><h2 id="_9-1-基础" tabindex="-1">9.1.基础 <a class="header-anchor" href="#_9-1-基础" aria-label="Permalink to &quot;9.1.基础&quot;">​</a></h2><h3 id="_9-1-1chrome如何运行wasm" tabindex="-1">9.1.1chrome如何运行Wasm <a class="header-anchor" href="#_9-1-1chrome如何运行wasm" aria-label="Permalink to &quot;9.1.1chrome如何运行Wasm&quot;">​</a></h3><p>浏览器内置JIT引擎，V8使用了分层编译模式（Tiered）来编译和优化 WASM 代码。分层编译模式包括两个主要的编译器：</p><ol><li>基线编译器（Baseline compiler） Liftoff编译器</li><li>优化编译器（Optimizing compiler） TurboFun编译器</li></ol><h3 id="_9-1-2chrome-编译流程" tabindex="-1">9.1.2chrome 编译流程 <a class="header-anchor" href="#_9-1-2chrome-编译流程" aria-label="Permalink to &quot;9.1.2chrome 编译流程&quot;">​</a></h3><ol><li><strong>解码（Decoding）</strong>：首先，将 WASM 模块解码为二进制可执行代码，并验证其是否符合 WASM 标准。</li><li><strong>基线编译（Baseline Compilation）</strong>：接下来，使用 Liftoff 编译器进行快速编译。这一阶段生成的代码性能较低，但编译速度快。流式编译在这个阶段发挥作用，使得代码在下载过程中就能进行编译。</li><li><strong>热点分析（Hotspot Analysis）</strong>：V8 引擎会持续监控 WASM 函数的调用频率，以识别 Hot Function。</li><li><strong>优化编译（Optimizing Compilation）</strong>：对于被标记为热门函数的代码，使用 TurboFan 编译器进行优化编译。编译完成后，优化后的代码会替换原有的 Liftoff 代码。这一过程称为分层升级（Tier-up）。</li><li><strong>执行（Execution）</strong>：在优化编译完成后，代码将在 V8 引擎中运行。</li></ol><h3 id="_9-1-3流式调用-和-编译" tabindex="-1">9.1.3流式调用 和 编译 <a class="header-anchor" href="#_9-1-3流式调用-和-编译" aria-label="Permalink to &quot;9.1.3流式调用 和 编译&quot;">​</a></h3><p>WebAssembly 缓存仅针对流式 API 调用， compileStreaming 和 instantiateStreaming 这两个API，使用流式API拥有更好的性能。对于缓存的工作原理：</p><ol><li>当TurboFan完成编译后，如果.wasm资源足够大（128 kb），Chrome 会将编译后的代码写入 WebAssembly 代码缓存。</li><li>当.wasm第二次请求资源时（hot run），Chrome.wasm从资源缓存中加载资源，同时查询代码缓存。如果缓存命中，编译后的module bytes将发送到渲染器进程并传递给 V8，V8将其进行反序列化，与编译相比，反序列化速度更快，占用的 CPU 更少。</li><li>如果.wasm资源发生了变化或是 V8 发生了变化，缓存会失效，缓存的本地代码会从缓存中清除，编译会像步骤 1 一样继续进行。</li></ol><h2 id="_9-2-emscript-c" tabindex="-1">9.2.emscript | c <a class="header-anchor" href="#_9-2-emscript-c" aria-label="Permalink to &quot;9.2.emscript | c&quot;">​</a></h2><p>官网：<a href="https://emscripten.org/" target="_blank" rel="noreferrer">https://emscripten.org/</a></p><h3 id="_9-2-1-环境" tabindex="-1">9.2.1 环境 <a class="header-anchor" href="#_9-2-1-环境" aria-label="Permalink to &quot;9.2.1  环境&quot;">​</a></h3><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># Get the emsdk repo</span></span>
<span class="line"><span style="color:#FFCB6B;">git</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">clone</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/emscripten-core/emsdk.git</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># Enter that directory</span></span>
<span class="line"><span style="color:#82AAFF;">cd</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">emsdk</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">emsdk</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">latest</span></span>
<span class="line"><span style="color:#FFCB6B;">emsdk</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">activate</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">latest</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># window</span></span>
<span class="line"><span style="color:#FFCB6B;">e:/emsdk/emsdk_env.bat</span><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># linux设置环境变量 source ./emsdk_env.sh.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 开始编译</span></span>
<span class="line"><span style="color:#FFCB6B;">emcc</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">math.c</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-Os</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-s</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">WASM=</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-s</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">SIDE_MODULE=</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-o</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">math.wasm</span></span></code></pre></div><h3 id="_9-2-2-c语言示例" tabindex="-1">9.2.2 c语言示例 <a class="header-anchor" href="#_9-2-2-c语言示例" aria-label="Permalink to &quot;9.2.2 c语言示例&quot;">​</a></h3><div class="language-c++"><button title="Copy Code" class="copy"></button><span class="lang">c++</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">#include &lt;emscripten.h&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">EMSCRIPTEN_KEEPALIVE</span></span>
<span class="line"><span style="color:#A6ACCD;">int square (int x) {</span></span>
<span class="line"><span style="color:#A6ACCD;">  return x * x;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span></code></pre></div><h3 id="_9-2-3-加载工具" tabindex="-1">9.2.3 加载工具 <a class="header-anchor" href="#_9-2-3-加载工具" aria-label="Permalink to &quot;9.2.3 加载工具&quot;">​</a></h3><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">loadWebAssembly</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">filename</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">imports</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{})</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">	</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">fetch</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">filename</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">then</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">response</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">response</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">arrayBuffer</span><span style="color:#F07178;">()) </span><span style="color:#676E95;font-style:italic;">// 转成 ArrayBuffer</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">then</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">buffer</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#A6ACCD;">imports</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">env</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">imports</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">env</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">||</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{};</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#A6ACCD;">Object</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">assign</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">imports</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">env</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// 初始化内存空间</span></span>
<span class="line"><span style="color:#F07178;">				memoryBase</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">         </span><span style="color:#676E95;font-style:italic;">// 创建变量映射表</span></span>
<span class="line"><span style="color:#F07178;">				tableBase</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">				__memory_base</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">				__table_base</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">				memory</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">WebAssembly</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Memory</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> initial</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">256</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> maximum</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">256</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">				table</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">WebAssembly</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Table</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">					initial</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">					maximum</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">					element</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">anyfunc</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">				</span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">			</span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">WebAssembly</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">instantiate</span><span style="color:#F07178;">(</span><span style="color:#A6ACCD;">buffer</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">imports</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 编译 + 实例化</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">		</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">then</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">result</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">result</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">instance</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span><span style="color:#F07178;"> </span><span style="color:#676E95;font-style:italic;">// 提取生成都模块</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><h3 id="_9-2-4-js加载调用" tabindex="-1">9.2.4 js加载调用 <a class="header-anchor" href="#_9-2-4-js加载调用" aria-label="Permalink to &quot;9.2.4 js加载调用&quot;">​</a></h3><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#82AAFF;">loadWebAssembly</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">./math.wasm</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">then</span><span style="color:#A6ACCD;">(</span><span style="color:#A6ACCD;font-style:italic;">instance</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">square</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">instance</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">exports</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">3^2 =</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">square</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">3</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">(2 + 5)^2 =</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">square</span><span style="color:#F07178;">(</span><span style="color:#F78C6C;">2</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">5</span><span style="color:#F07178;">))</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><h2 id="_9-3-emscript-c-打包成外部dll" tabindex="-1">9.3 emscript | c | 打包成外部dll <a class="header-anchor" href="#_9-3-emscript-c-打包成外部dll" aria-label="Permalink to &quot;9.3 emscript | c | 打包成外部dll&quot;">​</a></h2><h3 id="_9-3-1-cpp文件" tabindex="-1">9.3.1 cpp文件 <a class="header-anchor" href="#_9-3-1-cpp文件" aria-label="Permalink to &quot;9.3.1 cpp文件&quot;">​</a></h3><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">MyHeader.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">stdio.h</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> __stdcall </span><span style="color:#82AAFF;">init</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">a</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">b</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">printf</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">%d %d</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> a</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> b</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//  int  hello(int a, int b);</span></span></code></pre></div><h3 id="_9-3-2-h-文件" tabindex="-1">9.3.2 .h 文件 <a class="header-anchor" href="#_9-3-2-h-文件" aria-label="Permalink to &quot;9.3.2 .h 文件&quot;">​</a></h3><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#pragma</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">once</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#ifndef</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MyHeader</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MyHeader</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 定义当前宏</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">FETCH_API</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">_declspec</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">dllexport</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 宏替换</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#ifdef</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__cplusplus</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 告诉编译器是c语言代码</span></span>
<span class="line"><span style="color:#C792EA;">extern</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">C</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#endif</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// __stdcall 可以 让方法从左到右</span></span>
<span class="line"><span style="color:#A6ACCD;">    FETCH_API </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> __stdcall </span><span style="color:#82AAFF;">init</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">a</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">b</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#ifdef</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__cplusplus</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#endif</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#endif</span></span></code></pre></div><h2 id="_9-4-node-addon-api-c" tabindex="-1">9.4 Node-addon-api | c++ <a class="header-anchor" href="#_9-4-node-addon-api-c" aria-label="Permalink to &quot;9.4 Node-addon-api | c++&quot;">​</a></h2><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">npm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-g</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">node-gyp@9.4.0</span></span>
<span class="line"><span style="color:#FFCB6B;">npm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">bindings@1.5.0</span></span>
<span class="line"><span style="color:#FFCB6B;">npm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">node-addon-api@1.7.2</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">npm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--global</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--production</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">windows-build-tools</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 卡住不动 看这篇文章 vs 2017 2019 都可以 一开始的 https://blog.csdn.net/oqzuser1234asd/article/details/116169889 扩展包要选择 c++ 的 扩展</span></span></code></pre></div><h3 id="_9-4-1-gyp-xx-cc" tabindex="-1">9.4.1 gyp | xx.cc <a class="header-anchor" href="#_9-4-1-gyp-xx-cc" aria-label="Permalink to &quot;9.4.1 gyp | xx.cc&quot;">​</a></h3><p>新建 binding.gyp</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#676E95;font-style:italic;">//重要1：每个 target 描述了一个 C++ 扩展</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;">targets</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">//重要2：扩展名称</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">target_name</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">hello1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">//重要3：扩展源文件</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">sources</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">hello1.cc</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">],</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">//重要4：头文件路径</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">include_dirs</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">&lt;!@(node -p </span><span style="color:#A6ACCD;">\\&quot;</span><span style="color:#C3E88D;">require(&#39;node-addon-api&#39;).include</span><span style="color:#A6ACCD;">\\&quot;</span><span style="color:#C3E88D;">)</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">&lt;!@(node -p </span><span style="color:#A6ACCD;">\\&quot;</span><span style="color:#C3E88D;">require(&#39;node-addon-api&#39;).include.node</span><span style="color:#A6ACCD;">\\&quot;</span><span style="color:#C3E88D;">)</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">],</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span><span style="color:#676E95;font-style:italic;">//重要5：需要连接的库</span></span>
<span class="line"><span style="color:#A6ACCD;">    &#39;dependencies&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">&lt;!(node -p </span><span style="color:#A6ACCD;">\\&quot;</span><span style="color:#C3E88D;">require(&#39;node-addon-api&#39;).gyp</span><span style="color:#A6ACCD;">\\&quot;</span><span style="color:#C3E88D;">)</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">],</span></span>
<span class="line"><span style="color:#A6ACCD;">      &#39;conditions&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">&#39;OS==</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">win</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F78C6C;">msvs_settings</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">VCCLCompilerTool</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#89DDFF;">&quot;</span><span style="color:#916B53;">ExceptionHandling</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}],</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">&#39;OS==</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">mac</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F78C6C;">xcode_settings</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">&quot;</span><span style="color:#F07178;">CLANG_CXX_LIBRARY</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">libc++</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">            &#39;GCC_ENABLE_CPP_EXCEPTIONS&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> &#39;YES&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">            #&#39;MACOSX_DEPLOYMENT_TARGET&#39;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> &#39;</span><span style="color:#F78C6C;">10.7</span><span style="color:#A6ACCD;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}]</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><h3 id="_9-4-2-运行" tabindex="-1">9.4.2 运行 <a class="header-anchor" href="#_9-4-2-运行" aria-label="Permalink to &quot;9.4.2  运行&quot;">​</a></h3><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># node-gyp configure  的 时候发现 下载一直有问题，然后我们下载到本地去。然后添加下面的参数</span></span>
<span class="line"><span style="color:#FFCB6B;">node-gyp</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">configure</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--msvs_version=2019</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">--nodedir=E:</span><span style="color:#A6ACCD;">\\m</span><span style="color:#C3E88D;">yProject</span><span style="color:#A6ACCD;">\\w</span><span style="color:#C3E88D;">asm-examples-master</span><span style="color:#A6ACCD;">\\n</span><span style="color:#C3E88D;">ode-addon</span><span style="color:#A6ACCD;">\\n</span><span style="color:#C3E88D;">ode-v16.14.0-headers</span><span style="color:#A6ACCD;">\\n</span><span style="color:#C3E88D;">ode-v16.14.0</span><span style="color:#A6ACCD;">\\i</span><span style="color:#C3E88D;">nclude</span><span style="color:#A6ACCD;">\\n</span><span style="color:#C3E88D;">ode</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">node-gyp</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">build</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--msvs_version=2019</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">--nodedir=E:</span><span style="color:#A6ACCD;">\\m</span><span style="color:#C3E88D;">yProject</span><span style="color:#A6ACCD;">\\w</span><span style="color:#C3E88D;">asm-examples-master</span><span style="color:#A6ACCD;">\\n</span><span style="color:#C3E88D;">ode-addon</span><span style="color:#A6ACCD;">\\n</span><span style="color:#C3E88D;">ode-v16.14.0-headers</span><span style="color:#A6ACCD;">\\n</span><span style="color:#C3E88D;">ode-v16.14.0</span><span style="color:#A6ACCD;">\\i</span><span style="color:#C3E88D;">nclude</span><span style="color:#A6ACCD;">\\n</span><span style="color:#C3E88D;">ode</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">## 然后报错找不到 node_api.h,这个时候把上面下载的header的对应文件放进node_modules</span></span>
<span class="line"><span style="color:#FFCB6B;">https://nodejs.org/dist/v16.14.0/win-x64/node.lib</span></span>
<span class="line"><span style="color:#FFCB6B;">https://nodejs.org/download/release/v16.14.0/node-v16.14.0-headers.tar.gz</span></span></code></pre></div><h3 id="_9-4-3-调用" tabindex="-1">9.4.3 调用 <a class="header-anchor" href="#_9-4-3-调用" aria-label="Permalink to &quot;9.4.3 调用&quot;">​</a></h3><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> hello </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">require</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">./build/Release/hello1.node</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#A6ACCD;">(hello</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">hello</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">,</span><span style="color:#F78C6C;">34</span><span style="color:#A6ACCD;">))</span><span style="color:#89DDFF;">;</span></span></code></pre></div>`,36),e=[o];function t(c,r,y,D,F,i){return a(),n("div",null,e)}const d=s(p,[["render",t]]);export{A as __pageData,d as default};
